##############################################################################
#                                                                            #
# IAR ARM ANSI C/C++ Compiler V4.31A/W32 EVALUATION    07/Jan/2016  21:50:32 #
# Copyright 1999-2005 IAR Systems. All rights reserved.                      #
#                                                                            #
#    Cpu mode        =  interwork                                            #
#    Endian          =  little                                               #
#    Stack alignment =  4                                                    #
#    Source file     =  H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห๘ฮฒ #
#                       \ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQR_2 #
#                       014_7_31\kalman\imu.c                                #
#    Command line    =  H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห๘ฮฒ #
#                       \ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQR_2 #
#                       014_7_31\kalman\imu.c -lC                            #
#                       H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห๘ฮฒ #
#                       \ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQR_2 #
#                       014_7_31\AT91SAM7SE-USART_USB\Compil\FLASH_Debug\Lis #
#                       t\ -o H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6- #
#                       27ห๘ฮฒ\ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ #
#                       +LQR_2014_7_31\AT91SAM7SE-USART_USB\Compil\FLASH_Deb #
#                       ug\Obj\ -z9 --debug --cpu_mode thumb --endian        #
#                       little --cpu ARM7TDMI --stack_align 4 --interwork    #
#                       -e --fpu None --ec++ --dlib_config                   #
#                       D:\IAREWE431\ARM\LIB\dl4tptinl8n.h -I                #
#                       H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห๘ฮฒ #
#                       \ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQR_2 #
#                       014_7_31\AT91SAM7SE-USART_USB\Compil\srcIAR\ -I      #
#                       H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห๘ฮฒ #
#                       \ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQR_2 #
#                       014_7_31\AT91SAM7SE-USART_USB\Compil\..\src\ -I      #
#                       H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห๘ฮฒ #
#                       \ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQR_2 #
#                       014_7_31\AT91SAM7SE-USART_USB\Compil\..\..\ -I       #
#                       H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห๘ฮฒ #
#                       \ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQR_2 #
#                       014_7_31\AT91SAM7SE-USART_USB\Compil\..\..\kalman\   #
#                       -I H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห #
#                       ๘ฮฒ\ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQ #
#                       R_2014_7_31\AT91SAM7SE-USART_USB\Compil\..\..\pcm\   #
#                       -I H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห #
#                       ๘ฮฒ\ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQ #
#                       R_2014_7_31\AT91SAM7SE-USART_USB\Compil\..\..\spi\   #
#                       -I H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห #
#                       ๘ฮฒ\ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQ #
#                       R_2014_7_31\AT91SAM7SE-USART_USB\Compil\..\..\timer\ #
#                        -I H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27 #
#                       ห๘ฮฒ\ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+L #
#                       QR_2014_7_31\AT91SAM7SE-USART_USB\Compil\..\..\pid\  #
#                       -I H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห #
#                       ๘ฮฒ\ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQ #
#                       R_2014_7_31\AT91SAM7SE-USART_USB\Compil\..\..\avcs\  #
#                       -I D:\IAREWE431\ARM\INC\                             #
#    List file       =  H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห๘ฮฒ #
#                       \ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQR_2 #
#                       014_7_31\AT91SAM7SE-USART_USB\Compil\FLASH_Debug\Lis #
#                       t\imu.lst                                            #
#    Object file     =  H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห๘ฮฒ #
#                       \ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQR_2 #
#                       014_7_31\AT91SAM7SE-USART_USB\Compil\FLASH_Debug\Obj #
#                       \imu.r79                                             #
#                                                                            #
#                                                                            #
##############################################################################

H:\สตั้สานคื๗2015-8-20\2014-10-1สตั้สา\2015-6-27ห๘ฮฒ\ะกึฑษป๚ด๚ย๋ฒโสิ1-6\ะกึฑษป๚ด๚ย๋ฒโสิ\ยทพถนๆปฎ+LQR_2014_7_31\kalman\imu.c
      1          #include<includs.h>
      2          

   \                                 In segment DATA_Z, align 4, align-sorted
      3          double ahrs_pqr[3];
      4          double raw_ahrs_pqr[ 3 ];//***********************10.10.28**********************************
   \                     raw_ahrs_pqr:
   \   00000000                      DS8 24
      5          double ahrs_accel[3];
      6          double ahrs_compass[3];
      7          double imu_accel[3];
   \                     imu_accel:
   \   00000018                      DS8 24
   \                     ahrs_pqr:
   \   00000030                      DS8 24
      8          //----------------------LQR ฝวหูถศยหฒจิ๖ผำฒฮส-------------------//
      9          #define TIMES    6
     10          
     11          double filter_pqr[3];
   \                     filter_pqr:
   \   00000048                      DS8 24

   \                                 In segment DATA_Z, align 4, align-sorted
   \                     ahrs_accel:
   \   00000000                      DS8 24

   \                                 In segment DATA_Z, align 4, align-sorted
   \                     ahrs_compass:
   \   00000000                      DS8 24

   \                                 In segment DATA_Z, align 4, align-sorted
     12          static double pqr_window[3][TIMES] = {0.0};
   \                     pqr_window:
   \   00000000                      DS8 144
     13          //-------------------------------------------------------------//
     14          
     15          __inline  void IMU_OUTPUT(void)
     16          {
     17               AT91F_US_Put("$GPADC");
     18          	for( int i=0; i<8; i++ )
     19                  {	
     20          		//puts("0x");
     21          		while (!AT91F_US_TxReady(AT91C_BASE_US0));
     22          		  AT91F_US_PutChar(AT91C_BASE_US0, ',');
     23          		put_uint16_t( imuframe[i] );
     24          	}
     25                  AT91F_US_Put("\r\n");
     26                  AT91F_US_Put("$GPHDG");
     27          	for( int i=0; i<3; i++ )
     28                  {	
     29          		//puts("0x");
     30          		while (!AT91F_US_TxReady(AT91C_BASE_US0));
     31          		  AT91F_US_PutChar(AT91C_BASE_US0, ',');
     32          		put_uint16_t( pni_value[i] );
     33          	}
     34                  AT91F_US_Put("\r\n");
     35          }
     36          
     37          

   \                                 In segment CODE, align 4, keep-with-next
     38          void accel_filter(double filter_accel[3],const double imu_accel[3],unsigned int len)
     39          {
   \                     ??accel_filter:
   \   00000000   F5B5               PUSH        {R0,R2,R4-R7,LR}
   \   00000002   86B0               SUB         SP,#+24
   \   00000004   0A1C               MOV         R2,R1
     40               static double filter_container[30][3];
     41               double sum[3] = {0,0,0};
   \   00000006   6846               MOV         R0,SP
   \   00000008   0021               MOV         R1,#+0
   \   0000000A   1823               MOV         R3,#+24
   \                     ??accel_filter_1:
   \   0000000C   1B1F               SUB         R3,R3,#+4
   \   0000000E   C150               STR         R1,[R0, R3]
   \   00000010   FCD1               BNE         ??accel_filter_1
     42               static unsigned int length = 1;
     43               for(unsigned int i = len-1;i>0;i--)
   \   00000012   079B               LDR         R3,[SP, #+28]
   \   00000014   5B1E               SUB         R3,R3,#+1
   \   00000016   2D4F               LDR         R7,??accel_filter_2  ;; ??filter_container
   \   00000018   0EE0               B           ??accel_filter_3
     44                 for(unsigned int j=0;j<3;j++)
   \                     ??accel_filter_4:
   \   0000001A   0024               MOV         R4,#+0
   \   0000001C   1820               MOV         R0,#+24
   \   0000001E   5843               MUL         R0,R3
   \   00000020   3D18               ADD         R5,R7,R0
     45                   filter_container[i][j] = filter_container[i-1][j];
   \                     ??accel_filter_5:
   \   00000022   E000               LSL         R0,R4,#+3
   \   00000024   2E18               ADD         R6,R5,R0
   \   00000026   291C               MOV         R1,R5
   \   00000028   1839               SUB         R1,#+24
   \   0000002A   0818               ADD         R0,R1,R0
   \   0000002C   03C8               LDMIA       R0!,{R0,R1}
   \   0000002E   03C6               STMIA       R6!,{R0,R1}
   \   00000030   641C               ADD         R4,R4,#+1
   \   00000032   032C               CMP         R4,#+3
   \   00000034   F5D3               BCC         ??accel_filter_5
   \   00000036   5B1E               SUB         R3,R3,#+1
   \                     ??accel_filter_3:
   \   00000038   EFD1               BNE         ??accel_filter_4
     46               
     47               for(unsigned int j=0;j<3;j++)
   \   0000003A   0023               MOV         R3,#+0
     48                 filter_container[0][j] = imu_accel[j];
   \                     ??accel_filter_6:
   \   0000003C   D800               LSL         R0,R3,#+3
   \   0000003E   3C18               ADD         R4,R7,R0
   \   00000040   1018               ADD         R0,R2,R0
   \   00000042   03C8               LDMIA       R0!,{R0,R1}
   \   00000044   03C4               STMIA       R4!,{R0,R1}
   \   00000046   5B1C               ADD         R3,R3,#+1
   \   00000048   032B               CMP         R3,#+3
   \   0000004A   F7D3               BCC         ??accel_filter_6
     49               
     50               for(unsigned int i=0;i<length;i++)
   \   0000004C   0024               MOV         R4,#+0
   \   0000004E   13E0               B           ??accel_filter_7
     51                 for(unsigned int j=0;j<3;j++)
   \                     ??accel_filter_8:
   \   00000050   0025               MOV         R5,#+0
     52                   sum[j] += filter_container[i][j];
   \                     ??accel_filter_9:
   \   00000052   EA00               LSL         R2,R5,#+3
   \   00000054   6846               MOV         R0,SP
   \   00000056   8618               ADD         R6,R0,R2
   \   00000058   03CE               LDMIA       R6!,{R0,R1}
   \   0000005A   083E               SUB         R6,#+8
   \   0000005C   03B4               PUSH        {R0,R1}
   \   0000005E   1820               MOV         R0,#+24
   \   00000060   6043               MUL         R0,R4
   \   00000062   3818               ADD         R0,R7,R0
   \   00000064   8018               ADD         R0,R0,R2
   \   00000066   03C8               LDMIA       R0!,{R0,R1}
   \   00000068   0CBC               POP         {R2,R3}
   \   0000006A   ........           _BLF        __dAdd,??__dAdd??rT
   \   0000006E   03C6               STMIA       R6!,{R0,R1}
   \   00000070   6D1C               ADD         R5,R5,#+1
   \   00000072   032D               CMP         R5,#+3
   \   00000074   EDD3               BCC         ??accel_filter_9
   \   00000076   641C               ADD         R4,R4,#+1
   \                     ??accel_filter_7:
   \   00000078   1548               LDR         R0,??accel_filter_2+0x4  ;; ??length
   \   0000007A   0068               LDR         R0,[R0, #+0]
   \   0000007C   8442               CMP         R4,R0
   \   0000007E   E7D3               BCC         ??accel_filter_8
     53               
     54               for(unsigned int j=0;j<3;j++)
   \   00000080   0024               MOV         R4,#+0
     55                 filter_accel[j] = sum[j]/length;
   \                     ??accel_filter_10:
   \   00000082   E000               LSL         R0,R4,#+3
   \   00000084   0699               LDR         R1,[SP, #+24]
   \   00000086   0D18               ADD         R5,R1,R0
   \   00000088   6844               ADD         R0,SP
   \   0000008A   03C8               LDMIA       R0!,{R0,R1}
   \   0000008C   061C               MOV         R6,R0
   \   0000008E   0F1C               MOV         R7,R1
   \   00000090   0F48               LDR         R0,??accel_filter_2+0x4  ;; ??length
   \   00000092   0068               LDR         R0,[R0, #+0]
   \   00000094   ........           _BLF        __ulongToDouble,??__ulongToDouble??rT
   \   00000098   021C               MOV         R2,R0
   \   0000009A   0B1C               MOV         R3,R1
   \   0000009C   301C               MOV         R0,R6
   \   0000009E   391C               MOV         R1,R7
   \   000000A0   ........           _BLF        __dDiv,??__dDiv??rT
   \   000000A4   03C5               STMIA       R5!,{R0,R1}
   \   000000A6   641C               ADD         R4,R4,#+1
   \   000000A8   032C               CMP         R4,#+3
   \   000000AA   EAD3               BCC         ??accel_filter_10
     56               
     57               if(length < len)
   \   000000AC   0848               LDR         R0,??accel_filter_2+0x4  ;; ??length
   \   000000AE   0068               LDR         R0,[R0, #+0]
   \   000000B0   0799               LDR         R1,[SP, #+28]
   \   000000B2   8842               CMP         R0,R1
   \   000000B4   03D2               BCS         ??accel_filter_11
     58                 length++;
   \   000000B6   0648               LDR         R0,??accel_filter_2+0x4  ;; ??length
   \   000000B8   0068               LDR         R0,[R0, #+0]
   \   000000BA   401C               ADD         R0,R0,#+1
   \   000000BC   00E0               B           ??accel_filter_12
     59               else length = len;
   \                     ??accel_filter_11:
   \   000000BE   081C               MOV         R0,R1
   \                     ??accel_filter_12:
   \   000000C0   0349               LDR         R1,??accel_filter_2+0x4  ;; ??length
   \   000000C2   0860               STR         R0,[R1, #+0]
     60               
     61          }
   \   000000C4   08B0               ADD         SP,#+32
   \   000000C6   F0BC               POP         {R4-R7}
   \   000000C8   01BC               POP         {R0}
   \   000000CA   0047               BX          R0                 ;; return
   \                     ??accel_filter_2:
   \   000000CC   ........           DC32        ??filter_container
   \   000000D0   ........           DC32        ??length

   \                                 In segment DATA_Z, align 4, align-sorted
   \                     ??filter_container:
   \   00000000                      DS8 720

   \                                 In segment DATA_I, align 4, align-sorted
   \                     ??length:
   \   00000000                      DS8 4
   \   00000004                      REQUIRE `?<Initializer for length>`
     62          
     63          /*--------------------------------------------------------------------------------------*/
     64                  
     65                  
     66          /*--------------------------------------------------------------------------------------*/  

   \                                 In segment CODE, align 4, keep-with-next
     67          __inline void imu_update( void )
     68          {
   \                     ??imu_update:
   \   00000000   F0B5               PUSH        {R4-R7,LR}
   \   00000002   8BB0               SUB         SP,#+44
     69                  //---------------------------------
     70                  // ผ์ฒ้imuframeตฤฑ๊ึพฮป
     71                 double sum_pqr[3] = {0.0};
   \   00000004   05A8               ADD         R0,SP,#+20
   \   00000006   0021               MOV         R1,#+0
   \   00000008   1822               MOV         R2,#+24
   \                     ??imu_update_1:
   \   0000000A   121F               SUB         R2,R2,#+4
   \   0000000C   8150               STR         R1,[R0, R2]
   \   0000000E   FCD1               BNE         ??imu_update_1
     72          
     73                 char temp1 = 0;
     74                 char temp2 = 0;
   \   00000010   0020               MOV         R0,#+0
   \   00000012   0122               MOV         R2,#+1
   \   00000014   884C               LDR         R4,??imu_update_2  ;; imuframe
     75                 for( char i =1; i !=7; ++i)
     76                 if((imuframe[i] & 0x4000) != 0)
   \                     ??imu_update_3:
   \   00000016   9300               LSL         R3,R2,#+2
   \   00000018   E358               LDR         R3,[R4, R3]
   \   0000001A   5B04               LSL         R3,R3,#+17
   \   0000001C   02D5               BPL         ??imu_update_4
     77                         temp1 ++;
   \   0000001E   491C               ADD         R1,R1,#+1
   \   00000020   0906               LSL         R1,R1,#+24
   \   00000022   090E               LSR         R1,R1,#+24
   \                     ??imu_update_4:
   \   00000024   521C               ADD         R2,R2,#+1
   \   00000026   1306               LSL         R3,R2,#+24
   \   00000028   1B0E               LSR         R3,R3,#+24
   \   0000002A   072B               CMP         R3,#+7
   \   0000002C   F3D1               BNE         ??imu_update_3
     78                 if(imuframe[7] != 0)
   \   0000002E   E269               LDR         R2,[R4, #+28]
   \   00000030   002A               CMP         R2,#+0
   \   00000032   00D0               BEQ         ??imu_update_5
     79                         temp2 ++;
   \   00000034   0120               MOV         R0,#+1
     80                 if(temp1 >= 1)
   \                     ??imu_update_5:
   \   00000036   814A               LDR         R2,??imu_update_2+0x4  ;; imu_update_flag
   \   00000038   0029               CMP         R1,#+0
   \   0000003A   02D0               BEQ         ??imu_update_6
     81                 {
     82                     imu_update_flag = 3;//า็ณ๖    
   \   0000003C   0320               MOV         R0,#+3
   \                     ??imu_update_7:
   \   0000003E   1070               STRB        R0,[R2, #+0]
     83                     return ;
   \   00000040   F5E0               B           ??imu_update_8
     84                 }
     85                 if(temp2 >= 1)
   \                     ??imu_update_6:
   \   00000042   0028               CMP         R0,#+0
   \   00000044   01D0               BEQ         ??imu_update_9
     86                 {
     87                     imu_update_flag = 4;//IMUฑ๊ึพฮปทวมใฃฌณ๖ดํ    
   \   00000046   0420               MOV         R0,#+4
   \   00000048   F9E7               B           ??imu_update_7
     88                     return ;
     89                 }
     90          
     91                  int rate ;
     92          	rate = imuframe[ INDEX_GX ]&0x3FFF;	
   \                     ??imu_update_9:
   \   0000004A   7D4F               LDR         R7,??imu_update_2+0x8  ;; 0x3fff
   \   0000004C   6168               LDR         R1,[R4, #+4]
   \   0000004E   3940               AND         R1,R7
     93                  if(rate>0x1fff)rate=rate-0x4000;
   \   00000050   7C4E               LDR         R6,??imu_update_2+0xC  ;; 0xffffc000
   \   00000052   8025               MOV         R5,#+128
   \   00000054   AD01               LSL         R5,R5,#+6          ;; #+8192
   \   00000056   A942               CMP         R1,R5
   \   00000058   00DB               BLT         ??imu_update_10
   \   0000005A   8919               ADD         R1,R1,R6
   \                     ??imu_update_10:
   \   0000005C   7A4A               LDR         R2,??imu_update_2+0x10  ;; raw_ahrs_pqr
   \   0000005E   04B4               PUSH        {R2}
   \   00000060   4842               NEG         R0,R1
   \   00000062   ........           _BLF        __longToDouble,??__longToDouble??rT
   \   00000066   021C               MOV         R2,R0
   \   00000068   0B1C               MOV         R3,R1
   \   0000006A   7848               LDR         R0,??imu_update_2+0x14  ;; 0x9999999a
   \   0000006C   7849               LDR         R1,??imu_update_2+0x18  ;; 0x3fa99999
   \   0000006E   ........           _BLF        __dMul,??__dMul??rT
   \   00000072   021C               MOV         R2,R0
   \   00000074   0B1C               MOV         R3,R1
   \   00000076   7748               LDR         R0,??imu_update_2+0x1C  ;; 0xa2529d39
   \   00000078   7749               LDR         R1,??imu_update_2+0x20  ;; 0x3f91df46
   \   0000007A   ........           _BLF        __dMul,??__dMul??rT
   \   0000007E   04BC               POP         {R2}
   \   00000080   03C2               STMIA       R2!,{R0,R1}
     94          	raw_ahrs_pqr[ 0 ] = -rate * gyro_scale_x  ;
     95          		
     96              rate = imuframe[ INDEX_GY ]&0x3FFF;
   \   00000082   A168               LDR         R1,[R4, #+8]
   \   00000084   3940               AND         R1,R7
     97          	//rate = imuframe[ INDEX_GY] - gyro_zero_y;
     98                  if(rate>0x1fff)rate=rate-0x4000;
   \   00000086   A942               CMP         R1,R5
   \   00000088   00DB               BLT         ??imu_update_11
   \   0000008A   8919               ADD         R1,R1,R6
     99          	raw_ahrs_pqr[ 1 ] = -rate * gyro_scale_y  ;
   \                     ??imu_update_11:
   \   0000008C   734A               LDR         R2,??imu_update_2+0x24  ;; raw_ahrs_pqr + 8
   \   0000008E   04B4               PUSH        {R2}
   \   00000090   4842               NEG         R0,R1
   \   00000092   ........           _BLF        __longToDouble,??__longToDouble??rT
   \   00000096   021C               MOV         R2,R0
   \   00000098   0B1C               MOV         R3,R1
   \   0000009A   6C48               LDR         R0,??imu_update_2+0x14  ;; 0x9999999a
   \   0000009C   7049               LDR         R1,??imu_update_2+0x28  ;; 0xbfa99999
   \   0000009E   ........           _BLF        __dMul,??__dMul??rT
   \   000000A2   021C               MOV         R2,R0
   \   000000A4   0B1C               MOV         R3,R1
   \   000000A6   6B48               LDR         R0,??imu_update_2+0x1C  ;; 0xa2529d39
   \   000000A8   6B49               LDR         R1,??imu_update_2+0x20  ;; 0x3f91df46
   \   000000AA   ........           _BLF        __dMul,??__dMul??rT
   \   000000AE   04BC               POP         {R2}
   \   000000B0   03C2               STMIA       R2!,{R0,R1}
    100          	
    101                  rate = imuframe[ INDEX_GZ ]&0x3FFF;
   \   000000B2   E068               LDR         R0,[R4, #+12]
   \   000000B4   3840               AND         R0,R7
    102          	//rate = imuframe[ INDEX_GZ ] - gyro_zero_z;
    103                  if(rate>0x1fff)rate=rate-0x4000;
   \   000000B6   A842               CMP         R0,R5
   \   000000B8   00DB               BLT         ??imu_update_12
   \   000000BA   8019               ADD         R0,R0,R6
    104          	raw_ahrs_pqr[ 2 ] = rate * gyro_scale_z ;
   \                     ??imu_update_12:
   \   000000BC   694A               LDR         R2,??imu_update_2+0x2C  ;; raw_ahrs_pqr + 16
   \   000000BE   04B4               PUSH        {R2}
   \   000000C0   ........           _BLF        __longToDouble,??__longToDouble??rT
   \   000000C4   021C               MOV         R2,R0
   \   000000C6   0B1C               MOV         R3,R1
   \   000000C8   6048               LDR         R0,??imu_update_2+0x14  ;; 0x9999999a
   \   000000CA   6549               LDR         R1,??imu_update_2+0x28  ;; 0xbfa99999
   \   000000CC   ........           _BLF        __dMul,??__dMul??rT
   \   000000D0   021C               MOV         R2,R0
   \   000000D2   0B1C               MOV         R3,R1
   \   000000D4   5F48               LDR         R0,??imu_update_2+0x1C  ;; 0xa2529d39
   \   000000D6   6049               LDR         R1,??imu_update_2+0x20  ;; 0x3f91df46
   \   000000D8   ........           _BLF        __dMul,??__dMul??rT
   \   000000DC   04BC               POP         {R2}
   \   000000DE   03C2               STMIA       R2!,{R0,R1}
    105          	
    106                  rate = imuframe[ INDEX_AX ]&0x3FFF;
   \   000000E0   2169               LDR         R1,[R4, #+16]
   \   000000E2   3940               AND         R1,R7
    107          	//rate = imuframe[ INDEX_AX ] - bias_ax;
    108                  if(rate>0x1fff)rate=rate-0x4000;
   \   000000E4   A942               CMP         R1,R5
   \   000000E6   00DB               BLT         ??imu_update_13
   \   000000E8   8919               ADD         R1,R1,R6
    109                  	imu_accel[ 0 ] = -rate * accel_scale_x;
   \                     ??imu_update_13:
   \   000000EA   5F4A               LDR         R2,??imu_update_2+0x30  ;; raw_ahrs_pqr + 24
   \   000000EC   04B4               PUSH        {R2}
   \   000000EE   4842               NEG         R0,R1
   \   000000F0   ........           _BLF        __longToDouble,??__longToDouble??rT
   \   000000F4   021C               MOV         R2,R0
   \   000000F6   0B1C               MOV         R3,R1
   \   000000F8   5C48               LDR         R0,??imu_update_2+0x34  ;; 0x95e9e1b1
   \   000000FA   5D49               LDR         R1,??imu_update_2+0x38  ;; 0x3fa10cb2
   \   000000FC   ........           _BLF        __dMul,??__dMul??rT
   \   00000100   021C               MOV         R2,R0
   \   00000102   0B1C               MOV         R3,R1
   \   00000104   5B48               LDR         R0,??imu_update_2+0x3C  ;; 0xf5c28f5c
   \   00000106   5C49               LDR         R1,??imu_update_2+0x40  ;; 0x3fef5c28
   \   00000108   ........           _BLF        __dMul,??__dMul??rT
   \   0000010C   04BC               POP         {R2}
   \   0000010E   03C2               STMIA       R2!,{R0,R1}
    110            
    111                  rate = imuframe[ INDEX_AY ]&0x3FFF;
   \   00000110   6169               LDR         R1,[R4, #+20]
   \   00000112   3940               AND         R1,R7
    112          	//rate = imuframe[ INDEX_AY ] - bias_ay;
    113                  if(rate>0x1fff)rate=rate-0x4000;
   \   00000114   A942               CMP         R1,R5
   \   00000116   00DB               BLT         ??imu_update_14
   \   00000118   8919               ADD         R1,R1,R6
    114          	imu_accel[ 1 ] = -rate * accel_scale_y;
   \                     ??imu_update_14:
   \   0000011A   584A               LDR         R2,??imu_update_2+0x44  ;; raw_ahrs_pqr + 32
   \   0000011C   04B4               PUSH        {R2}
   \   0000011E   4842               NEG         R0,R1
   \   00000120   ........           _BLF        __longToDouble,??__longToDouble??rT
   \   00000124   021C               MOV         R2,R0
   \   00000126   0B1C               MOV         R3,R1
   \   00000128   5048               LDR         R0,??imu_update_2+0x34  ;; 0x95e9e1b1
   \   0000012A   5549               LDR         R1,??imu_update_2+0x48  ;; 0xbfa10cb2
   \   0000012C   ........           _BLF        __dMul,??__dMul??rT
   \   00000130   021C               MOV         R2,R0
   \   00000132   0B1C               MOV         R3,R1
   \   00000134   4F48               LDR         R0,??imu_update_2+0x3C  ;; 0xf5c28f5c
   \   00000136   5049               LDR         R1,??imu_update_2+0x40  ;; 0x3fef5c28
   \   00000138   ........           _BLF        __dMul,??__dMul??rT
   \   0000013C   04BC               POP         {R2}
   \   0000013E   03C2               STMIA       R2!,{R0,R1}
    115          	rate = imuframe[ INDEX_AZ ]&0x3FFF;
   \   00000140   A069               LDR         R0,[R4, #+24]
   \   00000142   0740               AND         R7,R0
   \   00000144   381C               MOV         R0,R7
    116                  
    117          	//rate = imuframe[ INDEX_AZ ] - bias_az;
    118                  if(rate>0x1fff)rate=rate-0x4000;
   \   00000146   AF42               CMP         R7,R5
   \   00000148   00DB               BLT         ??imu_update_15
   \   0000014A   8019               ADD         R0,R0,R6
    119          	imu_accel[ 2 ] = rate * accel_scale_z;
   \                     ??imu_update_15:
   \   0000014C   4D4C               LDR         R4,??imu_update_2+0x4C  ;; raw_ahrs_pqr + 40
   \   0000014E   ........           _BLF        __longToDouble,??__longToDouble??rT
   \   00000152   464A               LDR         R2,??imu_update_2+0x34  ;; 0x95e9e1b1
   \   00000154   4A4B               LDR         R3,??imu_update_2+0x48  ;; 0xbfa10cb2
   \   00000156   ........           _BLF        __dMul,??__dMul??rT
   \   0000015A   464A               LDR         R2,??imu_update_2+0x3C  ;; 0xf5c28f5c
   \   0000015C   464B               LDR         R3,??imu_update_2+0x40  ;; 0x3fef5c28
   \   0000015E   ........           _BLF        __dMul,??__dMul??rT
   \   00000162   03C4               STMIA       R4!,{R0,R1}
    120                  
    121                 for( char i=0 ; i<3 ; i++ )
   \   00000164   0024               MOV         R4,#+0
    122          	{
    123              	 imu_accel[i] = limit(imu_accel[i],-40.0,40.0);
   \                     ??imu_update_16:
   \   00000166   E000               LSL         R0,R4,#+3
   \   00000168   3749               LDR         R1,??imu_update_2+0x10  ;; raw_ahrs_pqr
   \   0000016A   0D18               ADD         R5,R1,R0
   \   0000016C   0020               MOV         R0,#+0
   \   0000016E   4649               LDR         R1,??imu_update_2+0x50  ;; 0x40440000
   \   00000170   03B4               PUSH        {R0,R1}
   \   00000172   0022               MOV         R2,#+0
   \   00000174   454B               LDR         R3,??imu_update_2+0x54  ;; 0xc0440000
   \   00000176   281C               MOV         R0,R5
   \   00000178   1830               ADD         R0,#+24
   \   0000017A   03C8               LDMIA       R0!,{R0,R1}
   \   0000017C   ........           _BLF        ??limit,??limit??rT
   \   00000180   1835               ADD         R5,#+24
   \   00000182   03C5               STMIA       R5!,{R0,R1}
    124          	}   
   \   00000184   641C               ADD         R4,R4,#+1
   \   00000186   02B0               ADD         SP,#+8
   \   00000188   2006               LSL         R0,R4,#+24
   \   0000018A   000E               LSR         R0,R0,#+24
   \   0000018C   0328               CMP         R0,#+3
   \   0000018E   EAD3               BCC         ??imu_update_16
    125               // ***********ิ๖ผำถิฝวหูถศตฤปฌถฏดฐฟฺยหฒจ2010.10.19*********************************
    126                 for( char i=0 ; i<3 ; i++ )
   \   00000190   0022               MOV         R2,#+0
    127          	{
    128          	    ahrs_pqr[i]=raw_ahrs_pqr[i];
   \                     ??imu_update_17:
   \   00000192   D000               LSL         R0,R2,#+3
   \   00000194   2C49               LDR         R1,??imu_update_2+0x10  ;; raw_ahrs_pqr
   \   00000196   0B18               ADD         R3,R1,R0
   \   00000198   3033               ADD         R3,#+48
   \   0000019A   0818               ADD         R0,R1,R0
   \   0000019C   03C8               LDMIA       R0!,{R0,R1}
   \   0000019E   03C3               STMIA       R3!,{R0,R1}
    129          	}
   \   000001A0   521C               ADD         R2,R2,#+1
   \   000001A2   1006               LSL         R0,R2,#+24
   \   000001A4   000E               LSR         R0,R0,#+24
   \   000001A6   0328               CMP         R0,#+3
   \   000001A8   F3D3               BCC         ??imu_update_17
    130          	
    131          	for(char j=0; j<3; j++)
   \   000001AA   0027               MOV         R7,#+0
    132          	{
    133          	
    134          		for(char i=1; i<TIMES; i++) 
   \                     ??imu_update_18:
   \   000001AC   0124               MOV         R4,#+1
   \   000001AE   3020               MOV         R0,#+48
   \   000001B0   7843               MUL         R0,R7
   \   000001B2   0290               STR         R0,[SP, #+8]
   \   000001B4   3649               LDR         R1,??imu_update_2+0x58  ;; pqr_window
   \   000001B6   0818               ADD         R0,R1,R0
   \   000001B8   0190               STR         R0,[SP, #+4]
   \   000001BA   F800               LSL         R0,R7,#+3
   \   000001BC   0090               STR         R0,[SP, #+0]
   \   000001BE   05A9               ADD         R1,SP,#+20
   \   000001C0   0E18               ADD         R6,R1,R0
    135              	{
    136          			sum_pqr[j] += pqr_window[j][i];
   \                     ??imu_update_19:
   \   000001C2   E500               LSL         R5,R4,#+3
   \   000001C4   03AA               ADD         R2,SP,#+12
   \   000001C6   0198               LDR         R0,[SP, #+4]
   \   000001C8   4019               ADD         R0,R0,R5
   \   000001CA   03C8               LDMIA       R0!,{R0,R1}
   \   000001CC   03C2               STMIA       R2!,{R0,R1}
   \   000001CE   03CE               LDMIA       R6!,{R0,R1}
   \   000001D0   083E               SUB         R6,#+8
   \   000001D2   021C               MOV         R2,R0
   \   000001D4   0B1C               MOV         R3,R1
   \   000001D6   03A8               ADD         R0,SP,#+12
   \   000001D8   03C8               LDMIA       R0!,{R0,R1}
   \   000001DA   ........           _BLF        __dAdd,??__dAdd??rT
   \   000001DE   03C6               STMIA       R6!,{R0,R1}
   \   000001E0   083E               SUB         R6,#+8
    137                  	pqr_window[j][i-1] = pqr_window[j][i];
   \   000001E2   0198               LDR         R0,[SP, #+4]
   \   000001E4   0838               SUB         R0,#+8
   \   000001E6   4219               ADD         R2,R0,R5
   \   000001E8   03A8               ADD         R0,SP,#+12
   \   000001EA   03C8               LDMIA       R0!,{R0,R1}
   \   000001EC   03C2               STMIA       R2!,{R0,R1}
    138              	}
   \   000001EE   641C               ADD         R4,R4,#+1
   \   000001F0   2006               LSL         R0,R4,#+24
   \   000001F2   000E               LSR         R0,R0,#+24
   \   000001F4   0628               CMP         R0,#+6
   \   000001F6   E4D3               BCC         ??imu_update_19
    139          	 
    140          		pqr_window[j][TIMES-1] = raw_ahrs_pqr[j];
   \   000001F8   0098               LDR         R0,[SP, #+0]
   \   000001FA   1349               LDR         R1,??imu_update_2+0x10  ;; raw_ahrs_pqr
   \   000001FC   0818               ADD         R0,R1,R0
   \   000001FE   03C8               LDMIA       R0!,{R0,R1}
   \   00000200   029A               LDR         R2,[SP, #+8]
   \   00000202   244B               LDR         R3,??imu_update_2+0x5C  ;; pqr_window + 40
   \   00000204   9A18               ADD         R2,R3,R2
   \   00000206   03C2               STMIA       R2!,{R0,R1}
    141          		sum_pqr[j] 			  += raw_ahrs_pqr[j];
   \   00000208   0CCE               LDMIA       R6!,{R2,R3}
   \   0000020A   083E               SUB         R6,#+8
   \   0000020C   ........           _BLF        __dAdd,??__dAdd??rT
   \   00000210   03C6               STMIA       R6!,{R0,R1}
    142          		filter_pqr[j] 		   = sum_pqr[j] / TIMES;
   \   00000212   009A               LDR         R2,[SP, #+0]
   \   00000214   0C4B               LDR         R3,??imu_update_2+0x10  ;; raw_ahrs_pqr
   \   00000216   9C18               ADD         R4,R3,R2
   \   00000218   4834               ADD         R4,#+72
   \   0000021A   0022               MOV         R2,#+0
   \   0000021C   1E4B               LDR         R3,??imu_update_2+0x60  ;; 0x40180000
   \   0000021E   ........           _BLF        __dDiv,??__dDiv??rT
   \   00000222   03C4               STMIA       R4!,{R0,R1}
    143          	}	
   \   00000224   7F1C               ADD         R7,R7,#+1
   \   00000226   3806               LSL         R0,R7,#+24
   \   00000228   000E               LSR         R0,R0,#+24
   \   0000022A   0328               CMP         R0,#+3
   \   0000022C   BED3               BCC         ??imu_update_18
   \                     ??imu_update_8:
   \   0000022E   0BB0               ADD         SP,#+44
   \   00000230   F0BC               POP         {R4-R7}
   \   00000232   01BC               POP         {R0}
   \   00000234   0047               BX          R0                 ;; return
   \   00000236   C046               NOP         
   \                     ??imu_update_2:
   \   00000238   ........           DC32        imuframe
   \   0000023C   ........           DC32        imu_update_flag
   \   00000240   FF3F0000           DC32        0x3fff
   \   00000244   00C0FFFF           DC32        0xffffc000
   \   00000248   ........           DC32        raw_ahrs_pqr
   \   0000024C   9A999999           DC32        0x9999999a
   \   00000250   9999A93F           DC32        0x3fa99999
   \   00000254   399D52A2           DC32        0xa2529d39
   \   00000258   46DF913F           DC32        0x3f91df46
   \   0000025C   ........           DC32        raw_ahrs_pqr + 8
   \   00000260   9999A9BF           DC32        0xbfa99999
   \   00000264   ........           DC32        raw_ahrs_pqr + 16
   \   00000268   ........           DC32        raw_ahrs_pqr + 24
   \   0000026C   B1E1E995           DC32        0x95e9e1b1
   \   00000270   B20CA13F           DC32        0x3fa10cb2
   \   00000274   5C8FC2F5           DC32        0xf5c28f5c
   \   00000278   285CEF3F           DC32        0x3fef5c28
   \   0000027C   ........           DC32        raw_ahrs_pqr + 32
   \   00000280   B20CA1BF           DC32        0xbfa10cb2
   \   00000284   ........           DC32        raw_ahrs_pqr + 40
   \   00000288   00004440           DC32        0x40440000
   \   0000028C   000044C0           DC32        0xc0440000
   \   00000290   ........           DC32        pqr_window
   \   00000294   ........           DC32        pqr_window + 40
   \   00000298   00001840           DC32        0x40180000
    144              //----------------SYCศฅต๔ฝวหูถศพ๙ึตยหฒจ------------------------//  
    145              /* for( char i=0 ; i<3 ; i++ )
    146          	{
    147          	 raw_ahrs_pqr[i] = limit(raw_ahrs_pqr[i],-5.23,5.23);
    148          	}   
    149                 
    150              static double p_window[10],q_window[10], r_window[10];
    151              double sum_p = 0, sum_q = 0, sum_r = 0;
    152              double filter_pqr[3]={0.0,0.0,0.0};
    153              static unsigned int length_pqr = 1;
    154                 //----------------------------
    155          	for(char i=1;i<5;i++) 
    156              {
    157              	sum_p += p_window[i];
    158                  p_window[i-1] = p_window[i];
    159              }
    160          	 
    161                 p_window[5-1]=raw_ahrs_pqr[0];
    162                 sum_p += raw_ahrs_pqr[0];
    163                //--------------------------------
    164                 for(char i=1;i<5;i++) 
    165              {
    166              	sum_q += q_window[i];
    167                  q_window[i-1] = q_window[i];
    168              }
    169          	 
    170                 q_window[5-1]=raw_ahrs_pqr[1];
    171                 sum_q += raw_ahrs_pqr[1];
    172                //-----------------------------------
    173                 for(char i=1;i<5;i++) 
    174              {
    175              	sum_r += r_window[i];
    176                  r_window[i-1] = r_window[i];
    177              }
    178          	 
    179                 r_window[5-1]=raw_ahrs_pqr[2];
    180                 sum_r += raw_ahrs_pqr[2];
    181                //----------------------------------
    182                 filter_pqr[0] = sum_p/length_pqr;
    183                 filter_pqr[1] = sum_q/length_pqr;
    184                 filter_pqr[2] = sum_r/length_pqr;
    185          
    186          	if(length_pqr >= 5)//for length_pqr ,max = N
    187          		length_pqr = 5;
    188          	else length_pqr++;
    189                 
    190                 for( char i=0 ; i<3 ; i++ )
    191          	{
    192          	 ahrs_pqr[i] = limit(filter_pqr[i],-2.0,2.0);
    193          	}   
    194           */
    195          } 
    196          
    197          /*--------------------------------------------------------------------------------------*/

   \                                 In segment CODE, align 4, keep-with-next
    198          __inline void compass_update( void )
    199          {
   \                     ??compass_update:
   \   00000000   70B5               PUSH        {R4-R6,LR}
    200              signed int rate;  
    201          	if( pni_value[INDEX_CX] > 32767 )
   \   00000002   164C               LDR         R4,??compass_update_1  ;; pni_value
   \   00000004   2068               LDR         R0,[R4, #+0]
   \   00000006   1649               LDR         R1,??compass_update_1+0x4  ;; 0xffff0000
   \   00000008   8022               MOV         R2,#+128
   \   0000000A   1202               LSL         R2,R2,#+8          ;; #+32768
   \   0000000C   9042               CMP         R0,R2
   \   0000000E   01DB               BLT         ??compass_update_2
    202          	    pni_value[INDEX_CX] = pni_value[INDEX_CX] - 65536;
   \   00000010   4018               ADD         R0,R0,R1
   \   00000012   2060               STR         R0,[R4, #+0]
    203              if( pni_value[INDEX_CY] > 32767 )
   \                     ??compass_update_2:
   \   00000014   6068               LDR         R0,[R4, #+4]
   \   00000016   9042               CMP         R0,R2
   \   00000018   01DB               BLT         ??compass_update_3
    204          	    pni_value[INDEX_CY] = pni_value[INDEX_CY] - 65536;
   \   0000001A   4018               ADD         R0,R0,R1
   \   0000001C   6060               STR         R0,[R4, #+4]
    205              if( pni_value[INDEX_CZ] > 32767 )
   \                     ??compass_update_3:
   \   0000001E   A068               LDR         R0,[R4, #+8]
   \   00000020   9042               CMP         R0,R2
   \   00000022   01DB               BLT         ??compass_update_4
    206          	    pni_value[INDEX_CZ] = pni_value[INDEX_CZ] - 65536;
   \   00000024   4018               ADD         R0,R0,R1
   \   00000026   A060               STR         R0,[R4, #+8]
    207             
    208                  rate = pni_value[ INDEX_CX ] - compass_bias_x;
    209          	ahrs_compass[ 0 ] = rate;
   \                     ??compass_update_4:
   \   00000028   0E4D               LDR         R5,??compass_update_1+0x8  ;; ahrs_compass
   \   0000002A   2068               LDR         R0,[R4, #+0]
   \   0000002C   F530               ADD         R0,#+245
   \   0000002E   ........           _BLF        __longToDouble,??__longToDouble??rT
   \   00000032   03C5               STMIA       R5!,{R0,R1}
   \   00000034   083D               SUB         R5,#+8
    210                  
    211          	rate = pni_value[ INDEX_CY ] - compass_bias_y;
    212          	ahrs_compass[ 1 ] = rate;
   \   00000036   2E1C               MOV         R6,R5
   \   00000038   0836               ADD         R6,#+8
   \   0000003A   6068               LDR         R0,[R4, #+4]
   \   0000003C   F421               MOV         R1,#+244
   \   0000003E   4900               LSL         R1,R1,#+1          ;; #+488
   \   00000040   4018               ADD         R0,R0,R1
   \   00000042   ........           _BLF        __longToDouble,??__longToDouble??rT
   \   00000046   03C6               STMIA       R6!,{R0,R1}
    213                  
    214          	rate = pni_value[ INDEX_CZ] - compass_bias_z;
    215          	ahrs_compass[ 2 ] = -rate ;      
   \   00000048   1035               ADD         R5,#+16
   \   0000004A   A168               LDR         R1,[R4, #+8]
   \   0000004C   5F39               SUB         R1,#+95
   \   0000004E   4842               NEG         R0,R1
   \   00000050   ........           _BLF        __longToDouble,??__longToDouble??rT
   \   00000054   03C5               STMIA       R5!,{R0,R1}
    216          }
   \   00000056   70BC               POP         {R4-R6}
   \   00000058   01BC               POP         {R0}
   \   0000005A   0047               BX          R0                 ;; return
   \                     ??compass_update_1:
   \   0000005C   ........           DC32        pni_value
   \   00000060   0000FFFF           DC32        0xffff0000
   \   00000064   ........           DC32        ahrs_compass
    217          

   \                                 In segment CODE, align 4, keep-with-next
    218           void sensor_update( void )
    219          {
   \                     ??sensor_update:
   \   00000000   00B5               PUSH        {LR}
    220          	imu_update();
   \   00000002   ........           _BLF        ??imu_update,??imu_update??rT
    221          	//printf("accel_x=%f\taccel_y=%f\taccel_z=%f\n",ahrs_accel[0],ahrs_accel[1],ahrs_accel[2]);
    222          	compass_update();
   \   00000006   ........           _BLF        ??compass_update,??compass_update??rT
    223          }
   \   0000000A   01BC               POP         {R0}
   \   0000000C   0047               BX          R0                 ;; return
    224          
    225          
    226          /********************************************************
    227          * บฏสหตร๗ฃบ *ผ์ฒ้imuframeสวท๑ำะมฌะ๘าปั๙ตฤึต,
    228                        ทภึนา๒ฮชimuป๒ี฿compassณ๖ดํ,ีโมฝี฿ตฤถมศกฝ๘ศ๋หภห๘.
    229          * ศ๋ฟฺฒฮสฃบ * ฮ 
    230          * ทตปุฒฮสฃบ * ฮ
    231          * สไศ๋สพสพภฃบ  
    232          * ื๎บ๓ะธฤฃบ * ณยำยฃฌ2009-03-26
    233          * ฑธ    ืขฃบ * ฮ
    234          ********************************************************/ 

   \                                 In segment CODE, align 4, keep-with-next
    235          void imu_monitor( )
    236          {
   \                     ??imu_monitor:
   \   00000000   30B5               PUSH        {R4,R5,LR}
    237                   static long last_imuframe[7] = {0,0,0,0,0,0,0};
    238                   static char  imu_error = 0;    
    239                   char imu_reset_flag = 0,     //ึุะยถมศกcompassบอimuตฤฑ๊ึพ
    240                        temp = 0;
   \   00000002   0021               MOV         R1,#+0
    241                  //--------ผ์ฒ้สวท๑สีตฝมฌะ๘ึุธดimuframe---------------
    242                  for( char i= 1 ; i!= 7 ;++i){
   \   00000004   0122               MOV         R2,#+1
    243                      if(last_imuframe[i] == imuframe[i])
   \                     ??imu_monitor_1:
   \   00000006   9300               LSL         R3,R2,#+2
   \   00000008   1748               LDR         R0,??imu_monitor_2  ;; imuframe
   \   0000000A   C458               LDR         R4,[R0, R3]
   \   0000000C   1748               LDR         R0,??imu_monitor_2+0x4  ;; ??imu_error
   \   0000000E   C318               ADD         R3,R0,R3
   \   00000010   5D68               LDR         R5,[R3, #+4]
   \   00000012   A542               CMP         R5,R4
   \   00000014   02D1               BNE         ??imu_monitor_3
    244                            temp ++;
   \   00000016   491C               ADD         R1,R1,#+1
   \   00000018   0906               LSL         R1,R1,#+24
   \   0000001A   090E               LSR         R1,R1,#+24
    245                      last_imuframe[i] = imuframe[i];  
   \                     ??imu_monitor_3:
   \   0000001C   5C60               STR         R4,[R3, #+4]
    246                  }
   \   0000001E   521C               ADD         R2,R2,#+1
   \   00000020   1306               LSL         R3,R2,#+24
   \   00000022   1B0E               LSR         R3,R3,#+24
   \   00000024   072B               CMP         R3,#+7
   \   00000026   EED1               BNE         ??imu_monitor_1
    247                  
    248                  if(temp == 6)
   \   00000028   0629               CMP         R1,#+6
   \   0000002A   17D1               BNE         ??imu_monitor_4
    249                      imu_error ++;
   \   0000002C   0178               LDRB        R1,[R0, #+0]
   \   0000002E   491C               ADD         R1,R1,#+1
    250                  else 
    251                     imu_error = 0 ; 
    252                  //---- ----------------------------------
    253                  if(imu_error >= 4) {    //4ื้imuframeฑฃณึฒปฑไ,ศฯฮชณ๖ดํ
   \   00000030   0906               LSL         R1,R1,#+24
   \   00000032   090E               LSR         R1,R1,#+24
   \   00000034   0429               CMP         R1,#+4
   \   00000036   12D3               BCC         ??imu_monitor_5
    254                     imu_reset_flag = 1;
    255                     imu_update_flag = 2;     
   \   00000038   0221               MOV         R1,#+2
   \   0000003A   0D4A               LDR         R2,??imu_monitor_2+0x8  ;; imu_update_flag
   \   0000003C   1170               STRB        R1,[R2, #+0]
    256                  }
    257          
    258                  //----------reset compass&imu---------
    259                  if(imu_reset_flag == 1) 
    260                  {
    261                    //-------compass reset-------- 
    262                       HDG = 2;
   \   0000003E   0D4A               LDR         R2,??imu_monitor_2+0xC  ;; HDG
   \   00000040   1170               STRB        R1,[R2, #+0]
    263                       //read_compass=1;
    264                       compass_update_flag=false;
   \   00000042   0D49               LDR         R1,??imu_monitor_2+0x10  ;; compass_update_flag
   \   00000044   0022               MOV         R2,#+0
   \   00000046   0A70               STRB        R2,[R1, #+0]
    265                       timer0_num=0;
   \   00000048   0C49               LDR         R1,??imu_monitor_2+0x14  ;; timer0_num
   \   0000004A   0A60               STR         R2,[R1, #+0]
    266                       AT91F_TC_InterruptDisable(AT91C_BASE_TC0,AT91C_TC_CPAS);
   \   0000004C   0C49               LDR         R1,??imu_monitor_2+0x18  ;; 0xfffa0028
   \   0000004E   0422               MOV         R2,#+4
   \   00000050   0A60               STR         R2,[R1, #+0]
    267                       
    268              //----------imu reset-------
    269                        imu_num = 0;
   \   00000052   0C49               LDR         R1,??imu_monitor_2+0x1C  ;; imu_num
   \   00000054   0022               MOV         R2,#+0
   \   00000056   0A70               STRB        R2,[R1, #+0]
    270                        raw_imu_update = false;
   \   00000058   0B49               LDR         R1,??imu_monitor_2+0x20  ;; raw_imu_update
   \   0000005A   0A70               STRB        R2,[R1, #+0]
    271               //----------ึุฦ๔บ๓reset ละถฯฑ๊ึพ-----
    272                        imu_reset_flag = 0;
    273                        imu_error = 0;
   \                     ??imu_monitor_4:
   \   0000005C   0021               MOV         R1,#+0
   \                     ??imu_monitor_5:
   \   0000005E   0170               STRB        R1,[R0, #+0]
    274                  }
    275          }
   \   00000060   30BC               POP         {R4,R5}
   \   00000062   01BC               POP         {R0}
   \   00000064   0047               BX          R0                 ;; return
   \   00000066   C046               NOP         
   \                     ??imu_monitor_2:
   \   00000068   ........           DC32        imuframe
   \   0000006C   ........           DC32        ??imu_error
   \   00000070   ........           DC32        imu_update_flag
   \   00000074   ........           DC32        HDG
   \   00000078   ........           DC32        compass_update_flag
   \   0000007C   ........           DC32        timer0_num
   \   00000080   2800FAFF           DC32        0xfffa0028
   \   00000084   ........           DC32        imu_num
   \   00000088   ........           DC32        raw_imu_update

   \                                 In segment DATA_Z, align 4, align-sorted
   \                     ??imu_error:
   \   00000000                      DS8 1
   \   00000001                      DS8 3
   \   00000004                      DS8 28

   \                                 In segment DATA_ID, align 4, align-sorted
   \                     `?<Initializer for length>`:
   \   00000000   01000000           DC32 1

   \                                 In segment DATA_C, align 4, align-sorted
   \   00000000   000000000000       DC32 0H, 0H, 0H, 0H, 0H, 0H
   \              000000000000
   \              000000000000
   \              000000000000

   \                                 In segment DATA_C, align 4, align-sorted
   \   00000000   000000000000       DC32 0H, 0H
   \              0000        
   \   00000008   000000000000       DC8 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
   \              000000000000
   \              00000000    

   Maximum stack usage in bytes:

     Function                       CSTACK
     --------                       ------
     accel_filter(double *, double const *, unsigned int)
                                       60
     compass_update()                  16
     imu_monitor()                     12
     imu_update()                      72
     sensor_update()                    4


   Segment part sizes:

     Function/Label                 Bytes
     --------------                 -----
     raw_ahrs_pqr                     96
     ahrs_accel                       24
     ahrs_compass                     24
     pqr_window                      144
     accel_filter(double *, double const *, unsigned int)
                                     212
     filter_container                720
     length                            4
     imu_update()                    668
     compass_update()                104
     sensor_update()                  14
     imu_monitor()                   140
     imu_error                        32
     ?<Initializer for length>         4
     ?<Constant {(0.0), (0.0), (0.0)}>
                                      24
     ?<Constant {(0.0)}>              24
      Others                         144

 
 1 258 bytes in segment CODE
    48 bytes in segment DATA_C
     4 bytes in segment DATA_I
     4 bytes in segment DATA_ID
 1 040 bytes in segment DATA_Z
    24 bytes in segment INITTAB
 
   366 bytes of CODE  memory (+ 916 bytes shared)
    52 bytes of CONST memory
 1 044 bytes of DATA  memory

Errors: none
Warnings: none
